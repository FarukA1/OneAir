@page
@model OneAir.Views.Home.IndexModel
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="text-center">
    <h1 class="display-4">OneAir Monitoring System</h1>
    <p>Under Construction.</p>
    <div id="demo"></div>
    <div id="mapid"></div>
</div>

<style>
    #mapid {
        height: 500px;
    }
</style>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
        integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
        crossorigin=""></script>
<script>
    async function getLocation() {
        var x = document.getElementById("demo");
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
                let lat = position.coords.latitude;
                let long = position.coords.longitude;

                x.innerHTML = "Your Location" + "<br>Latitude: " + position.coords.latitude +
                    "<br>Longitude: " + position.coords.longitude;

                const mymap = L.map('mapid').setView([lat, long], 13);

                L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoiZmFydWthMSIsImEiOiJja2p2bGpic2YwYTFuMndzZHpjbXowdTFsIn0.w6ULN29W4Chm7-L37UwW5Q', {
                    attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
                    maxZoom: 18,
                    id: 'mapbox/streets-v11',
                    tileSize: 512,
                    zoomOffset: -1,
                    accessToken: 'your.mapbox.access.token'
                }).addTo(mymap);

                const api_url = 'https://oneair.1809152.win.studentwebserver.co.uk/api/airqualities';

                async function getData() {
                    const response = await fetch(api_url);
                    const data = await response.json();
                    console.log(data);


                    for (var i = 0; i < data.length; ++i) {

                        function getColor(pM25) {
                            return pM25 <= 50 ? '#00ff00' :
                                pM25 <= 100 ? '#ffff00' :
                                    pM25 <= 150 ? '#ffa500' :
                                        pM25 <= 200 ? '#ff0000' :
                                            pM25 <= 300 ? '#800080' :
                                                pM25 >= 301 ? '#800000' :
                                                        '#000000';
                        }


                        L.circle([data[i].latitude, data[i].longitude], { color: getColor(data[i].pM25)})
                            .bindPopup(
                                '<h3 style="float:center;"> AirQuality Information</h3>' + '<br>' +
                                '<p style="font-size:12px;"> DeviceID: ' + data[i].deviceID + '</p>' +
                                '<p style="font-size:12px;"> Time: ' + data[i].time + '</p>' +
                                '<p style="font-size:12px;"> Latitude: ' + data[i].latitude + '</p>' +
                                '<p style="font-size:12px;"> Lomgitude: ' + data[i].longitude + '</p>' +
                                '<p style="font-size:12px;"> pM10: ' + data[i].pM10 + '</p>' +
                                '<p style="font-size:12px;"> pM2.5: ' + data[i].pM25 + '</p>'
                                )
                            @*.bindPopup(data[i].latitude)*@
                            .addTo(mymap);
                    }
                    
                }
                getData();

                @*testing data*@
                var circle = L.circle([51.508, -0.11], {
                    color: 'red',
                    fillColor: '#f03',
                    fillOpacity: 0.5,
                    radius: 500
                })
                    .bindPopup('Welcome to OneAir')
                    .addTo(mymap);
            });
        } else {
            x.innerHTML = "Geolocation is not supported by this browser.";
        }
    }
    getLocation();
</script>
